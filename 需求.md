``` 
使用springsecurity进行权限控制，非管理员不能进行某些操作







```
#数据库设计
```
user(用户)：
user_id(用户id)password(密码)username(用户名)nickname(昵称)
authority(权限)email(邮箱)head(头像)authenticated(是否实名认证)
real_name(真实姓名)identity_card(身份证号)balance(余额)frozen(是否被冻结)


order(订单):
order_id(订单id)buyer_price(买家出价)account_id(账号id)
checked(是否验货)paid(是否付款)canceled(是否被取消)fav(是否被买家收藏)finished(是否已经完成)
默认值：false

account(账号):
game_name(游戏名) account_number(账号) password(密码) detail(详情) price(出价)
seller_id(卖家id) account_id(账号id) varified(是否审核通过) bought(是否被购买)

problem(问题)：
problem_id(问题id) order_id(订单id) detail(问题内容) solved(是否被处理) agreed(卖家是否同意处理结果)
report(举报)：
report_id(举报id) whistleblower_id(告发者id) defendant_id(被告者id) cause(原因) handled(是否被处理) result(审核结果)
debt(欠债)
debt_id(债务id) debtor_id(欠债者id) amount(金额) account_id() wiped(是否还清)

```
#接口设计
``` 
/user
功能：注册  参数：username,password  返回值:userId 描述：用户名不能重复
/user/login
功能：登录  参数：username,password  返回值：token  
/account
功能：挂出账号 参数：token game_name(游戏名) account_number(账号) password(密码) detail(详情) price(出价) 返回值：account_id
/admin/list
功能：提供所有待审核的账号 参数：token 返回值：待审核账号列表(varified==false)
/admin/pass
功能：审核通过,修改varified值,商品上架 参数：token account_id 返回值：(ws)给卖家:type(system_message) key(examine_message) message("您的某某账号审核通过") data(账号信息) 
/admin/fail
功能：审核不通过 参数：token，sellerId,cause,account_id 返回值：(ws)type(system_message),key(examine_message) message("您的某某账号未过审,原因是cause"),data(账号信息) 
/seller/update
功能：卖家修改商品信息 参数：token account_id 返回值：账号信息
/seller/list
功能：列出该卖家挂出并审核成功的所有账号 参数：token 返回值：账号列表
/buyer/list
功能：根据条件列出所有过审账号供挑选 参数：token 可选条件[gamename,price,account_number] 返回值：账号列表
/buyer/offer
功能:买家出价，给卖家发送出价消息 参数：token,sellerId,price,account_id 返回值：(ws)给卖家：type(system_message),key(offer_message) message(某某用户对某账号出价多少) data(账号信息,price,buyer信息),前端提醒卖家哪个买家给哪个商品出价多少，并可以与其聊天，可以同意
/seller/agree
功能：卖家同意，修改bought值(先冻结，防止其他人购买，如果交易最后不成功,改回来)给买家发送付款提醒,将付款消息加入付款延时队列，给卖家发送信息：等待买家付款... ，添加订单到订单表中 参数：token,buyerId,price,account_id 返回值：(ws) 给买家：type(system_message),key(pay_message),data(账号信息,price) message(您是否同意以price的价格购买账号) 给卖家：type(system_message) key(normal_message) message("等待买家付款") (http)order_id  
/buyer/pay
功能：买家付款，买家余额减少，修改payed值，给买家发送账号完整信息(包括密码等)，将验货消息加入验货延时队列 参数：token,account_id,order_id,price 返回值:(ws)给买家：type(system_message) key(account_message) message("支付成功，账号信息如下") data(账号信息) 给卖家：type(system_message) key(normal_message) message("买家已付款，正在等待其检验...")
/buyer/nopay
功能：买家拒绝付款, 删除订单(修改cancled值)修改bought值(解冻) 给卖家发消息 参数：token,seller_id 返回值：(ws) 给卖家 type(system_message) key(normal_message) message("买家拒绝付款，交易已取消") 
/buyer/check
功能：买家确认收货，交易结束，卖家余额增长,修改checked值 修改finished值 从验货延迟队列中删除消息 参数：order_id,token,seller_id 返回值：(ws) 给卖家 type(system_message) key(normal_message) message("买家已确认收货")
/buyer/uncheck
功能：买家拒绝收货 系统通知卖家 将取消交易消息加入取消消息延时队列 参数：token,seller_id,order_id 返回值：(ws)给卖家：type(system_message) key(cancelOrder_message) message("买家拒绝收货,请确认账号,并选择取消交易或不取消交易") data(账号信息,order_id) 
/seller/cancel
功能：卖家主动取消交易 交易结束，删除订单(修改cancled值)，修改bought值(解冻),退款给买家，系统通知买家 参数：token,order_id返回值：(ws) 给买家 type(system_message) key(normal_message) message("卖家已取消交易，余额返还")
/seller/nocancel
功能：卖家拒绝取消交易,提交问题给管理员(添加到数据库) 参数：token,orderId,problem 返回值：(ws)给买家： type(system_message) key(normal_message) message("卖家拒绝取消交易，等待管理员审核") 给卖家：message("已提交问题，等待管理员审核")
/user/report
功能：用户举报  参数：token,report_cause,defendant_id 返回值:  message("举报成功，等待管理员审核")
/admin/report/list
功能：列出所有未被处理的举报 参数：token 返回值:举报列表
/admin/freeze
功能：管理员如果发现是找回账号的举报，可以第一时间冻结卖家账号 参数：token defendant_id 返回值： message("冻结成功")
/admin/report/handle
功能：管理员处理举报，修改handled值 并根据passed和report_type值不同做出不同处理 参数：token,report_id,passed,[handle_type(retrieve_account_report),order_id]||[handle_type(normal_report)]  defendant_id 
/admin/problem/handle
功能：管理员处理交易问题 将交易问题处理消息加入延时队列参数：token,level,problem_id [money] 




```
#消息类型
``` 
[type]      
1 system_message
2 chat_message
[key]
1 examine_message
2 offer_message
3 pay_message
4 account_message
5 normal_message
6 cancleOrder_message
7 transaction_issues_message
```
#举报类型
``` 
[passed]
1 true  
2 false  
[report_type]
1 retrieve_account_report (true)根据seller_id查出卖家余额，如果够，就按order里的price价格返还给买家，解冻，加入黑名单
不够，将卖家钱包里的余额全数返还，将卖家加入讨债表里，并拉入黑名单。修改result为"管理员审核通过，该用户已被拉入黑名单"  
(false) 修改result为"管理员未发现账号问题，审核不通过"
2 normal_report (true) result"感谢您的举报
 ，我们已经将该用户拉入黑名单"
(false) result"我们暂时未发现该用户存在违规行为"
```
#权限类型
``` 
[authority]
normal_user
blacklist_user
admin
```
#交易问题处理程度
``` 
[level]
light(轻度受损):参数加上money (ws)type(system_message)key(transaction_issues_message)给卖家:data(money,order信息)


```
#聊天室设计
``` 
websocket/socketio
```

#实现
``` 
离线消息使用一个队列进行存储
系统消息和聊天设计应该分开设计
在订单表里加上是否付款,是否验货,是否被取消字段，在死信队列里的消息被消费时，先去查询有没有付款或有没有验货成功，如果没付款就取消订单，没验货就自动默认成已验货，没主动取消就加入问题备案
在问题表中加入是否同意，没同意到时间自动同意
在websocket里写一个sendmessge方法，然后在管理员审核完的http请求接口里调用这个方法，就可以实现将管理员的失败原因实时推送给用户了
如果是管理员发的消息和正常聊天发的消息，呈现的形式应该是不一样的，要在消息里加上消息类型，然后前端根据消息类型用不同的方式展示
```